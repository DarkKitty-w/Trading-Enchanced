pandas
numpy
ccxt
supabase
python-dotenv
aiohttp
requests
scipy
plotly
seaborn
matplotlib
optuna
streamlit
pandas_ta

-- ============================================================================
-- TABLES PRINCIPALES POUR PHOENIX TRADING BOT
-- ============================================================================

BEGIN;

-- Enable the UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp" WITH SCHEMA public;

-- 1. Strategies Table
-- Stores registered strategies
CREATE TABLE IF NOT EXISTS public.strategies (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name TEXT UNIQUE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- 2. Strategy Cash Table
-- Stores isolated capital per strategy
CREATE TABLE IF NOT EXISTS public.strategy_cash (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    strategy_id UUID NOT NULL,
    initial_cash NUMERIC(20, 8) NOT NULL,
    available_cash NUMERIC(20, 8) NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
    CONSTRAINT fk_strategy
        FOREIGN KEY(strategy_id)
        REFERENCES public.strategies(id)
        ON DELETE CASCADE
);

-- 3. Positions Table
-- Stores open & closed positions per strategy
CREATE TABLE IF NOT EXISTS public.positions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    strategy_id UUID NOT NULL,
    symbol TEXT NOT NULL,
    side TEXT NOT NULL CHECK (side IN ('LONG', 'SHORT')),
    quantity NUMERIC(20, 8) NOT NULL,
    entry_price NUMERIC(20, 8) NOT NULL,
    exit_price NUMERIC(20, 8),
    status TEXT NOT NULL CHECK (status IN ('OPEN', 'CLOSED')),
    opened_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
    closed_at TIMESTAMP WITH TIME ZONE,
    CONSTRAINT fk_strategy
        FOREIGN KEY(strategy_id)
        REFERENCES public.strategies(id)
        ON DELETE CASCADE
);

-- 4. Trades Table
-- Stores each executed trade (paper)
CREATE TABLE IF NOT EXISTS public.trades (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    strategy_id UUID NOT NULL,
    symbol TEXT NOT NULL,
    side TEXT NOT NULL CHECK (side IN ('BUY', 'SELL')),
    price NUMERIC(20, 8) NOT NULL,
    quantity NUMERIC(20, 8) NOT NULL,
    executed_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
    CONSTRAINT fk_strategy
        FOREIGN KEY(strategy_id)
        REFERENCES public.strategies(id)
        ON DELETE CASCADE
);

-- 5. Performance Metrics Table
-- Stores metrics per strategy per run
CREATE TABLE IF NOT EXISTS public.performance_metrics (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    strategy_id UUID NOT NULL,
    total_pnl NUMERIC(20, 8),
    sharpe_ratio NUMERIC(10, 5),
    max_drawdown NUMERIC(20, 8),
    win_rate NUMERIC(5, 4),
    trades_count INTEGER,
    calculated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
    CONSTRAINT fk_strategy
        FOREIGN KEY(strategy_id)
        REFERENCES public.strategies(id)
        ON DELETE CASCADE
);

-- Add useful indexes
CREATE INDEX IF NOT EXISTS idx_strategy_cash_strategy_id ON public.strategy_cash(strategy_id);
CREATE INDEX IF NOT EXISTS idx_positions_strategy_id ON public.positions(strategy_id);
CREATE INDEX IF NOT EXISTS idx_positions_symbol ON public.positions(symbol);
CREATE INDEX IF NOT EXISTS idx_positions_opened_at ON public.positions(opened_at);
CREATE INDEX IF NOT EXISTS idx_trades_strategy_id ON public.trades(strategy_id);
CREATE INDEX IF NOT EXISTS idx_trades_symbol ON public.trades(symbol);
CREATE INDEX IF NOT EXISTS idx_trades_executed_at ON public.trades(executed_at);
CREATE INDEX IF NOT EXISTS idx_performance_metrics_strategy_id ON public.performance_metrics(strategy_id);
CREATE INDEX IF NOT EXISTS idx_performance_metrics_calculated_at ON public.performance_metrics(calculated_at);

COMMIT;
